#!/data/data/com.termux/files/usr/bin/bash

SITE="/storage/emulated/0/BIZHOST"
PIDFILE="$PREFIX/tmp/bizhost.pid"
TMP="$PREFIX/tmp/bizhostlink.log"

mkdir -p "$PREFIX/tmp"
mkdir -p "$SITE"

# ===== BOOT =====
clear
echo -e "\e[1;32mBooting BIZHOST OS...\e[0m"
for i in {1..30}; do printf "█"; sleep 0.03; done
sleep 0.5
echo ""
echo -e "\e[1;36mInitializing secure modules...\e[0m"
sleep 0.5
echo -e "\e[1;31mSecurity layer active\e[0m"
sleep 0.5
echo -e "\e[1;32mSystem ready\e[0m"
sleep 1

while true
do
clear

# ===== BIZ FACTORY BRAND LOGO =====
echo -e "\e[1;32m██████╗ ██╗███████╗     ███████╗ █████╗  ██████╗ ████████╗ ██████╗ ██████╗ ██╗   ██╗"
echo "██╔══██╗██║╚══███╔╝     ██╔════╝██╔══██╗██╔════╝ ╚══██╔══╝██╔═══██╗██╔══██╗╚██╗ ██╔╝"
echo -e "\e[1;36m██████╔╝██║  ███╔╝█████╗█████╗  ███████║██║         ██║   ██║   ██║██████╔╝ ╚████╔╝ \e[0m"
echo -e "\e[1;36m██╔══██╗██║ ███╔╝ ╚════╝██╔══╝  ██╔══██║██║         ██║   ██║   ██║██╔══██╗  ╚██╔╝  \e[0m"
echo -e "\e[1;33m██████╔╝██║███████╗     ██║     ██║  ██║╚██████╗    ██║   ╚██████╔╝██║  ██║   ██║   \e[0m"
echo -e "\e[1;33m╚═════╝ ╚═╝╚══════╝     ╚═╝     ╚═╝  ╚═╝ ╚═════╝    ╚═╝    ╚═════╝ ╚═╝  ╚═╝   ╚═╝   \e[0m"

echo -e "\e[1;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo -e "\e[1;36m        ⚡ BIZHOST — BIZ FACTORY ⚡\e[0m"
echo -e "\e[1;31m        Secure • Lightweight • Mobile Hosting\e[0m"
echo -e "\e[1;37m        USER : $(whoami)\e[0m"
echo -e "\e[1;33m        ROOT : $SITE\e[0m"
echo -e "\e[1;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo ""

# ===== MENU =====
echo "[ 1 ] Start Server (Auto Public Link)"
echo "[ 2 ] Open Site Folder"
echo "[ 3 ] Stop Server"
echo "[ X ] Exit"
echo ""

read -p "BIZHOST > " opt

case $opt in

# ===== START SERVER =====
1)
clear

if [ -f "$PIDFILE" ] && kill -0 $(cat "$PIDFILE") 2>/dev/null; then
    echo "Server already running"
    sleep 2
    continue
fi

pkill cloudflared 2>/dev/null

php -S 127.0.0.1:8080 -t "$SITE" > /dev/null 2>&1 &
echo $! > "$PIDFILE"

echo -e "\e[1;36mStarting PHP server...\e[0m"
sleep 2

rm -f "$TMP"
cloudflared tunnel --url http://127.0.0.1:8080 > "$TMP" 2>&1 &

sleep 8

LINK=$(grep -o 'https://[-a-zA-Z0-9\.]*trycloudflare.com' "$TMP" | head -n 1)

clear
echo -e "\e[1;32m━━━━━━━━ SERVER ONLINE ━━━━━━━━\e[0m"
echo -e "\e[1;37mLocal  : http://localhost:8080\e[0m"

if [ -n "$LINK" ]; then
    echo -e "\e[1;33mPublic : $LINK\e[0m"
else
    echo -e "\e[1;31mPublic : Failed to create link\e[0m"
fi

echo -e "\e[1;32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo ""
echo "Keep terminal open for public access"
echo "Press CTRL + C to stop public link"

tail -f /dev/null
;;

# ===== OPEN FOLDER =====
2)
cd "$SITE"
bash
;;

# ===== STOP SERVER =====
3)
clear

if [ -f "$PIDFILE" ]; then
    kill $(cat "$PIDFILE") 2>/dev/null
    rm -f "$PIDFILE"
fi

pkill php 2>/dev/null
pkill cloudflared 2>/dev/null

echo -e "\e[1;32mServer stopped\e[0m"
sleep 2
;;

x|X)
exit
;;

*)
echo "Invalid option"
sleep 1
;;

esac

done
