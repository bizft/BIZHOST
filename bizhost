#!/data/data/com.termux/files/usr/bin/bash

CONFIG="$PREFIX/tmp/bizhost.conf"
PIDFILE="$PREFIX/tmp/bizhost.pid"
WATCHDOG="$PREFIX/tmp/bizhost.watchdog"
TMP="$PREFIX/tmp/bizhostlink.log"

mkdir -p "$PREFIX/tmp"

# ===== LOAD OR SET SITE DIRECTORY =====
if [ -f "$CONFIG" ]; then
    SITE=$(cat "$CONFIG")
else
    SITE="/storage/emulated/0/BIZHOST"
    echo "$SITE" > "$CONFIG"
fi

mkdir -p "$SITE"

# ===== FUNCTIONS =====

start_server() {

# Kill old server & watchdog
pkill php 2>/dev/null
[ -f "$WATCHDOG" ] && kill $(cat "$WATCHDOG") 2>/dev/null && rm -f "$WATCHDOG"

# ===== WATCHDOG LOOP =====
(
while true
do
    php -S 127.0.0.1:8080 -t "$SITE" > /dev/null 2>&1 &
    SERVER_PID=$!

    echo $SERVER_PID > "$PIDFILE"

    # Wait until server ready (fix 502)
    for i in {1..20}; do
        curl -s http://127.0.0.1:8080 > /dev/null && break
        sleep 0.5
    done

    wait $SERVER_PID

    echo "Server crashed — restarting..."
    sleep 1
done
) &

echo $! > "$WATCHDOG"

echo "Server running → http://localhost:8080"
sleep 2
}

create_tunnel() {

if [ ! -f "$PIDFILE" ]; then
    echo "Start server first!"
    sleep 2
    return
fi

pkill cloudflared 2>/dev/null
rm -f "$TMP"

cloudflared tunnel --url http://127.0.0.1:8080 > "$TMP" 2>&1 &
sleep 8

LINK=$(grep -o 'https://[-a-zA-Z0-9\.]*trycloudflare.com' "$TMP" | head -n 1)

clear
echo "======================================"
echo "           PUBLIC ACCESS"
echo "======================================"
echo "Local  : http://localhost:8080"

if [ -n "$LINK" ]; then
    echo "Public : $LINK"
else
    echo "Public : FAILED"
fi

echo "======================================"
echo ""
echo "CTRL+C to stop public access"

tail -f /dev/null
}

stop_server() {

pkill php 2>/dev/null
pkill cloudflared 2>/dev/null

[ -f "$WATCHDOG" ] && kill $(cat "$WATCHDOG") 2>/dev/null && rm -f "$WATCHDOG"
rm -f "$PIDFILE"

echo "Server stopped"
sleep 2
}

# ===== BOOT =====
clear
echo "Booting BIZ HOST..."
sleep 1

while true
do
clear

# ===== BIZ HOST LOGO =====
echo -e "\e[1;32m██████╗ ██╗███████╗     ██╗  ██╗ ██████╗ ███████╗████████╗\e[0m"
echo -e "\e[1;32m██╔══██╗██║╚══███╔╝     ██║  ██║██╔═══██╗██╔════╝╚══██╔══╝\e[0m"
echo -e "\e[1;36m██████╔╝██║  ███╔╝█████╗███████║██║   ██║███████╗   ██║   \e[0m"
echo -e "\e[1;36m██╔══██╗██║ ███╔╝ ╚════╝██╔══██║██║   ██║╚════██║   ██║   \e[0m"
echo -e "\e[1;33m██████╔╝██║███████╗     ██║  ██║╚██████╔╝███████║   ██║   \e[0m"
echo -e "\e[1;33m╚═════╝ ╚═╝╚══════╝     ╚═╝  ╚═╝ ╚═════╝ ╚══════╝   ╚═╝   \e[0m"

echo -e "\e[1;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo -e "\e[1;36m        ⚡ BIZ HOST — BIZ FACTORY ⚡\e[0m"
echo -e "\e[1;31m        Secure • Lightweight • Mobile Hosting\e[0m"
echo -e "\e[1;37m        USER : $(whoami)\e[0m"
echo -e "\e[1;33m        ROOT : $SITE\e[0m"
echo -e "\e[1;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo ""

# ===== MENU =====
echo "[1] Start Server"
echo "[2] Create Public Link"
echo "[3] Set Site Directory"
echo "[4] Open Site Folder"
echo "[5] Stop Server"
echo "[6] Update BIZ HOST"
echo "[X] Exit"
echo ""

read -p "BIZHOST > " opt

case $opt in

1)
clear
echo "Starting server..."
start_server

echo ""
echo "SERVER ACTIVE"
echo "Local → http://localhost:8080"
echo ""
read -p "Press ENTER to return to menu..."
;;

2)
create_tunnel
;;

3)
read -p "Enter new directory path: " NEWDIR

if [ -n "$NEWDIR" ]; then
    mkdir -p "$NEWDIR"
    SITE="$NEWDIR"
    echo "$SITE" > "$CONFIG"
    echo "Directory updated → $SITE"
else
    echo "Invalid path"
fi

sleep 2
;;

4)
cd "$SITE"
bash
;;

5)
stop_server
;;

6)
echo "Updating packages..."
pkg update -y && pkg upgrade -y
sleep 2
;;

x|X)
exit
;;

*)
echo "Invalid option"
sleep 1
;;

esac

done
